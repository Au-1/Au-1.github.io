<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="author" content="Au Taoo"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="revisit-after" content="7 days"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" type="application/rss+xml" title="Au Taoo's Blog" href="/feed.xml"><meta name="msapplication-TileColor" content="#ffffff"><title>The Magic in Shiki Magic Move</title><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" crossorigin="" src="/assets/app-mY-s16NI.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-4cgh7IZ0.css"><link rel="modulepreload" crossorigin="" href="/assets/shiki-magic-move-LyDQCRKK.js"><meta property="og:title" content="The Magic in Shiki Magic Move"><meta name="twitter:title" content="The Magic in Shiki Magic Move"><meta name="description" content="The methodology behind Shiki Magic Move."><meta property="og:description" content="The methodology behind Shiki Magic Move."><meta name="twitter:description" content="The methodology behind Shiki Magic Move."><meta property="og:image" content="https://antfu.me/og/shiki-magic-move.png"><meta name="twitter:image" content="https://antfu.me/og/shiki-magic-move.png"><meta name="twitter:card" content="summary_large_image"></head><body class="font-sans text-gray-700 dark:text-gray-200 relative"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-d5d4f4c1=""><a href="/" class="w-12 h-12 absolute xl:fixed m-5 select-none outline-none" focusable="false" data-v-d5d4f4c1=""><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="50.000000px" height="50.000000px" viewBox="0 0 485.000000 183.000000" preserveAspectRatio="xMidYMid meet" fill="none" data-v-d5d4f4c1="" data-v-186592de=""><title data-v-186592de="">au</title><g transform="translate(-100.000000,450.000000) scale(0.3500000,-0.3500000)" data-v-186592de=""><path class="path1" stroke="black" stroke-width="10" stroke-linecap="round" d="M1112 1184 l-152 -184 -170 0 c-104 0 -170 -4 -170 -10 0 -6 64 -11 160 -12 l159 -3 -144 -175 c-129 -156 -165 -209 -136 -198 5 2 68 75 141 163 198 241 167 215 261 215 72 0 80 -2 75 -17 -38 -126 -97 -315 -102 -327 -4 -10 -1 -16 8 -16 7 0 53 61 102 135 48 74 90 135 92 135 2 0 1 -13 -2 -30 -11 -50 20 -50 72 1 24 24 44 41 44 39 0 -3 -7 -26 -15 -53 -25 -83 -1 -100 57 -39 44 45 128 174 121 185 -8 13 -32 -13 -95 -105 -33 -49 -63 -86 -66 -84 -3 3 10 46 28 96 17 50 29 94 26 97 -4 4 -36 -26 -72 -66 -37 -39 -69 -70 -72 -67 -2 3 6 33 18 66 23 61 21 86 -4 59 -8 -8 -53 -72 -100 -144 -47 -71 -86 -126 -86 -122 0 5 17 63 37 129 27 87 43 122 55 126 21 5 24 18 6 24 -9 3 3 54 40 178 30 95 50 176 45 181 -4 4 -77 -75 -161 -177z m77 -48 l-43 -136 -73 0 c-59 0 -72 3 -66 13 17 28 217 267 220 263 3 -2 -15 -65 -38 -140z" data-v-186592de=""></path></g></svg></a><button title="Scroll to top" fixed="" right-3="" bottom-3="" w-10="" h-10="" hover:op100="" rounded-full="" hover-bg-hex-8883="" transition="" duration-300="" z-100="" print:hidden="" class="op0! pointer-events-none" data-v-d5d4f4c1=""><div i-ri-arrow-up-line="" data-v-d5d4f4c1=""></div></button><nav class="nav" data-v-d5d4f4c1=""><div class="spacer" data-v-d5d4f4c1=""></div><div class="right" print:op0="" data-v-d5d4f4c1=""><a href="/posts" class="" title="Blog" data-v-d5d4f4c1=""><span class="lt-md:hidden" data-v-d5d4f4c1="">Blog</span><div i-ri-article-line="" md:hidden="" data-v-d5d4f4c1=""></div></a><a href="/projects" class="" title="Projects" data-v-d5d4f4c1=""><span class="lt-md:hidden" data-v-d5d4f4c1="">Projects</span><div i-ri-lightbulb-line="" class="md:hidden" data-v-d5d4f4c1=""></div></a><a href="https://github.com/AuTaoo" target="_blank" title="GitHub" class="lt-md:hidden" data-v-d5d4f4c1=""><div i-uil-github-alt="" data-v-d5d4f4c1=""></div></a><a class="select-none" title="Toggle Color Scheme" data-v-d5d4f4c1=""><div i-ri-sun-line="" dark:i-ri-moon-line=""></div></a></div></nav></header><main class="px-7 py-10 of-x-hidden"><!--[--><!----><div class="prose m-auto mb-8"><h1 class="mb-0 slide-enter-50">The Magic in Shiki Magic Move</h1><p class="opacity-50 !-mt-6 slide-enter-50">Mar 4 <span>¬∑ 15min</span></p><!----><!----><!----></div><article class=""><!--[--><div class="prose m-auto slide-enter-content"><p></p><div class="table-of-contents"><div class="table-of-contents-anchor"><div class="i-ri-menu-2-fill"></div></div><ul><li><a href="#how-it-works">How it works</a></li><li><a href="#transitions">Transitions</a><ul><li><a href="#enter-transition">Enter Transition</a></li><li><a href="#leave-transition">Leave Transition</a></li><li><a href="#move-transition">Move Transition</a></li></ul></li><li><a href="#integrations">Integrations</a></li></ul></div><p></p><div><div flex="~" py2="" mb--2="" mt--2=""><div flex-1="" border-b="" mb--1px="" class="border-transparent"><button w-full="" border-x="" border-t="" border-base="" rounded-t="" px2="" py1="" transition="" duration-300="" class="bg-base">Options API</button></div><div flex-1="" border-b="" mb--1px="" class="border-base"><button w-full="" border-x="" border-t="" border-base="" rounded-t="" px2="" py1="" transition="" duration-300="" class="bg-gray:5 op25 hover:op75">Composition API</button></div></div><div class="font-mono h-95 important-p4 border border-base important-rounded-b-none important-bg-transparent flex items-center justify-center">Loading...</div></div><p><a href="https://support.apple.com/guide/keynote/add-transitions-tanff5ae749e/mac" target="_blank" rel="noopener">Magic Move is a feature for transition in Keynote</a>, or it‚Äôs called <a href="https://support.microsoft.com/en-us/office/use-the-morph-transition-in-powerpoint-8dd1c7b2-b935-44f5-a74c-741d8d9244ea" target="_blank" rel="noopener">Morph Transition in PowerPoint</a>, and it automatically animates the transitions for objects between slides. It is quite impressive, very intuitive and effortless to use, and can be applied to various types of objects. Like you can paste a highlighted code block, or make another in a second slide, Magic Move will do the transition as granular to the tokens level for you.</p><p>The only annoying part of this process is that Keynote does not support code highlighting - so you need to highlight the code somewhere and paste them manually <strong>every single time</strong>. This is one of the reasons I made <a href="https://sli.dev/" target="_blank" rel="noopener">Slidev</a> - to have first-class tooling for developers to make presentations easier. While moving to web technologies with Slidev opens up almost infinite possibilities, on the other hand, it also makes some nice cool features in Keynote and PowerPoint harder to achieve (you need to write quite some extra code) - for example, the Magic Move.</p><p>Browsers‚Äô new <a href="https://developer.mozilla.org/en-US/docs/Web/API/View_Transitions_API" target="_blank" rel="noopener">View Transitions API</a> makes morphing between elements a lot easier, only that it requires some manual work to assign keys to make the pairs. While it‚Äôs rather ok to do for a few big elements, doing such manually for every single token in a code block is basically unacceptable.</p><p>Roughly a year ago, <a href="https://github.com/posva" target="_blank" rel="noopener">Eduardo @posva</a> and I came up with the idea of using Shiki combined with Vue‚Äôs <a href="https://vuejs.org/guide/built-ins/transition-group" target="_blank" rel="noopener"><code>&lt;TransitionGroup&gt;</code></a> to achieve a similar effect for code blocks:</p><div class="flex items-center justify-center" h-650px=""><blockquote class="twitter-tweet" data-theme="light"><!--[--><p lang="en" dir="ltr">Do you like Magic Move in Keynote for code?<a href="https://twitter.com/antfu7?ref_src=twsrc%5Etfw">@antfu7</a> and I are cooking something üòé <a href="https://t.co/9JxjCzRA1S">pic.twitter.com/9JxjCzRA1S</a></p>‚Äî Eduardo.ùöüùöûùöé (@posva) <a href="https://twitter.com/posva/status/1619083357756821504?ref_src=twsrc%5Etfw">January 27, 2023</a><!--]--></blockquote></div><p>We managed to make the proof of concept work, as shown in the video. However, due to some hard edge cases, both of us were busy with other things, and we didn‚Äôt manage to make it a usable library at that time. It has come to our discussions from time to time but we didn‚Äôt come up with a good solution. Until one day, a few weeks ago while I was preparing my slides, my <a href="https://lmddgtfy.net/?q=Productive%20Procrastination" target="_blank" rel="noopener"><s>productive</s> procrastination</a> kicked in and I decided to give it another try to <s>escape from my slides</s>.</p><p>And luck me, I found a quite nice approach and made it happen:</p><div class="flex items-center justify-center" h-670px=""><blockquote class="twitter-tweet" data-theme="light"><!--[--><p lang="en" dir="ltr">The procrastination in preparing talks drove me to bring up the rework of the idea we had last year with <a href="https://twitter.com/posva?ref_src=twsrc%5Etfw">@posva</a> - animate Shiki tokens like Magic Move! ü™Ñ<br><br>Found a much more reliable approach that could finally come out as a library (soon)<a href="https://t.co/b5SgQtTw2s">https://t.co/b5SgQtTw2s</a> <a href="https://t.co/s5LutlYmAK">pic.twitter.com/s5LutlYmAK</a></p>‚Äî Au Taoo (@antfu7) <a href="https://twitter.com/antfu7/status/1760751386122211371?ref_src=twsrc%5Etfw">February 22, 2024</a><!--]--></blockquote></div><p>Made <a href="https://shiki-magic-move.netlify.app/" target="_blank" rel="noopener">a playground</a> where you can try it out yourself, and you can find the source code at <span ws-nowrap=""><svg style="vertical-align:sub" class="inline inline-block" viewBox="0 0 32 32" width="1.2em" height="1.2em"><path fill="currentColor" fill-rule="evenodd" d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2"></path></svg><a class="opacity-70 ml-1 font-mono" href="https://github.com/shikijs/shiki-magic-move" target="_blank">shikijs/shiki-magic-move</a></span>.</p><p>So today here, let‚Äôs break it down and see how it works.</p><h2 id="how-it-works" tabindex="-1">How it works <a class="header-anchor" href="#how-it-works" aria-hidden="true">#</a></h2><p>To get started, we could see each word in the code with different colors as a token (they are <code>&lt;span&gt;</code> elements in practice). Basically, we can consider them as a set of small objects that we want to animate individually.</p><p>To break done the animations of Magic Move, we see we are basically trying to find connections between two sets of objects and animate them from one to another. Different from 1-to-1 transitions, here we expect the code before and after to be different, which means we could categorize the type of transitions into 3 categories:</p><!--[--><ol><li transition="" class=""><strong transition="" class="">Move</strong>: The token exists in both before and after, so we just need to move it to the new position.</li><li transition="" class=""><strong transition="" class="">Enter</strong>: The token only exists in the <strong>after</strong>, we need to animate the element entering the scene.</li><li transition="" class=""><strong transition="" class="">Leave</strong>: The token only exists in the <strong>before</strong>, we need to animate the element leaving the scene.</li></ol><p>Here is a playground for you to inspect the type of each token, hover over to inspect:</p><!----><!--]--><p>In the playground above, we assign a key to each token. <code>Move</code> tokens come with pairs, so we assign the same key to make the "connection".</p><p>When doing highlighting, <a href="https://github.com/shikijs/shiki" target="_blank" rel="noopener">Shiki</a> turns the input code into an array of tokens. We can run Shiki twice for code before and after to get two collections of tokens. It should be fairly simple to find the <code>Enter</code> and <code>Leave</code> tokens by running two loops to compare the two collections. However, the challenge is to find good pairs of <code>Move</code> tokens. If we only pair them by the content of each token, it would be the case that 1-to-many or many-to-1 might make the pair transition off.</p><p>I came up with the idea of using a text diff algorithm to find the chunks of the code that are matched between the two versions. I ended up using Google‚Äôs <a href="https://github.com/google/diff-match-patch" target="_blank" rel="noopener">Diff Match Patch</a> (I later refactored it into ESM as <a href="https://github.com/antfu/diff-match-patch-es" target="_blank" rel="noopener"><code>diff-match-patch-es</code></a>) to achieve this. With the diff result, we can now <a href="https://github.com/shikijs/shiki-magic-move/blob/e409aa5cf877a4005cf2b01729f1113beb405d13/src/core.ts#L226-L256" target="_blank" rel="noopener">reliably find the pairs</a> of the <code>Move</code> tokens without worrying that tokens might travel to the wrong place.</p><p>With this core logic in place, we can generate the correct keys for each token for the connection. This made the rest of the task clear, we just needed to apply different transitions to different types of tokens. We could feed them into any key-based transition library, for example, Vue provides a built-in <a href="https://vuejs.org/guide/built-ins/transition-group" target="_blank" rel="noopener"><code>&lt;TransitionGroup&gt;</code> component</a> that does the job perfectly, <a href="https://vuejs.org/examples/#list-transition" target="_blank" rel="noopener">live example</a>.</p><h2 id="transitions" tabindex="-1">Transitions <a class="header-anchor" href="#transitions" aria-hidden="true">#</a></h2><p>While Vue‚Äôs <code>&lt;TransitionGroup&gt;</code> should get the transition done automatically, it‚Äôs actually a bit tricky to do in our specific case. The main reason is that the token elements in the code are <code>&lt;span&gt;</code> that rely on browsers‚Äô layout engine to calculate the position. During the transition, we want to make each token positioned absolutely to avoid messing up the layout. This means we need to record the position of each token with <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect" target="_blank" rel="noopener"><code>getBoundingClientRect()</code></a> before the transition starts, apply the absolute position to them during transitions, and then restore to the inline layout after the transition ends.</p><p>Ran into some limitations of <code>&lt;TransitionGroup&gt;</code> and also with the wish to have this a framework-agnostic solution, I ended up writing <a href="https://github.com/shikijs/shiki-magic-move/blob/5ec48554d87b4f4e2dd2e15f27ef9e51ef00074b/src/renderer.ts#L28" target="_blank" rel="noopener">a custom renderer</a> to do that, referencing a lot of the code from <code>&lt;TransitionGroup&gt;</code>.</p><p>Because we are relying on the browsers‚Äô layout engine to calculate the position, we need to get the destination position of each token (the position of the final code) before the transition starts. I found this trick in Vue‚Äôs code to <a href="https://github.com/vuejs/core/blob/f66a75ea75c8aece065b61e2126b4c5b2338aa6e/packages/runtime-dom/src/components/TransitionGroup.ts#L77-L78" target="_blank" rel="noopener">force layout reflow</a> combined with temporary setting <a href="https://github.com/vuejs/core/blob/f66a75ea75c8aece065b61e2126b4c5b2338aa6e/packages/runtime-dom/src/components/TransitionGroup.ts#L186-L187" target="_blank" rel="noopener">transition duration to 0</a> to get the new position immediately so we could start animating.</p><p>Then it comes to do the transitions for different types of tokens:</p><h3 id="enter-transition" tabindex="-1">Enter Transition <a class="header-anchor" href="#enter-transition" aria-hidden="true">#</a></h3><p>The enter transition is the most straightforward one. Because the token will stay at the destination position after the transition, we don‚Äôt need to do anything with the positioning. We usually just need to apply the opacity transition to make it appear. Here we add/remove classes for users to apply the transition with CSS.</p><p>Pseudo-code below:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> enterElements</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-enter</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-enter-from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Replace the children of the container with</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// elements from the new code</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">container</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">replaceChildren</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">newChildren</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Force layout reflow</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">forceReflow</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> enterElements</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">remove</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-enter-from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-enter-to</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Here the transition starts</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// from `.transition-enter-from` to `.transition-enter-to`</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> enterElements</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // Transition Finished</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">addEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transitionend</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">remove</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-enter-to</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p><a href="https://github.com/shikijs/shiki-magic-move/blob/5ec48554d87b4f4e2dd2e15f27ef9e51ef00074b/src/renderer.ts#L233-L249" target="_blank" rel="noopener">[actual source code]</a></p><h3 id="leave-transition" tabindex="-1">Leave Transition <a class="header-anchor" href="#leave-transition" aria-hidden="true">#</a></h3><p>Since "Leave" tokens eventually disappear after the transition, we need to keep them in the DOM tree for a while for animations but we don‚Äôt want them to participate in the layout. We can apply <code>position: absolute</code> to them and set the <code>top</code> and <code>left</code> to the original position to make them stay in place. Then we can apply the opacity transition to make them disappear.</p><p>Pseudo-code below:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> leaveElements</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // Get the position of the token stored before</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">pos</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> position</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // Set absolute position</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">style</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">position</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">absolute</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">style</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">top</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> `</span><span style="--s-dark:#666666;--s-light:#999999">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">pos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#C98A7D;--s-light:#B56959">y</span><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#C98A7D;--s-light:#B56959">px</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">`</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">style</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">left</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> `</span><span style="--s-dark:#666666;--s-light:#999999">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">pos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#C98A7D;--s-light:#B56959">x</span><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#C98A7D;--s-light:#B56959">px</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">`</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-leave</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-leave-from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Replace the children of the container</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Same as the enter transition</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">container</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">replaceChildren</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">newChildren</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">forceReflow</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> enterElements</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">remove</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-leave-from</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-leave-to</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> enterElements</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">addEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transitionend</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">remove</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-leave-to</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p><a href="https://github.com/shikijs/shiki-magic-move/blob/5ec48554d87b4f4e2dd2e15f27ef9e51ef00074b/src/renderer.ts#L206-L229" target="_blank" rel="noopener">[actual source code]</a></p><h3 id="move-transition" tabindex="-1">Move Transition <a class="header-anchor" href="#move-transition" aria-hidden="true">#</a></h3><p>To animate "Move" tokens requires a bit more work. We use a technique called <a href="https://aerotwist.com/blog/flip-your-animations/" target="_blank" rel="noopener">"FLIP"</a> (First, Last, Invert, Play) to make the transition smooth. We need to record the position of each token before the transition starts, then apply the absolute position to them during the transition, and then restore it to the inline layout after the transition ends.</p><p>It‚Äôs a bit unintuitive to understand at first, but luckily <a href="https://css-tricks.com/author/davidkpiano/" target="_blank" rel="noopener">David Khourshid</a> made a great explanation at <a href="https://css-tricks.com/animating-layouts-with-the-flip-technique/" target="_blank" rel="noopener">Animating Layouts with the FLIP Technique</a>, definitely worth reading!</p><p>Pseudo-code below:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> moveElements</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">newPos</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">getBoundingClientRect</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">oldPos</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> position</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">dx</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> oldPos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">newPos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">dy</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> oldPos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">newPos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // Set duration to 0 to get the new position immediately</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">style</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">transitionDuration</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">0ms</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">style</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">transitionDelay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">0ms</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // Transform new elements to the old position</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">style</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">transform</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> `</span><span style="--s-dark:#C98A7D;--s-light:#B56959">translate(</span><span style="--s-dark:#666666;--s-light:#999999">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">dx</span><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#C98A7D;--s-light:#B56959">px, </span><span style="--s-dark:#666666;--s-light:#999999">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">dy</span><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#C98A7D;--s-light:#B56959">px)</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">`</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Replace the children of the container</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">container</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">replaceChildren</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">newChildren</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">forceReflow</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> moveElements</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // Remove transform overrides,</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // so it will start animating back to the new position</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-move</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">style</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">transform</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> ''</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">style</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">transitionDuration</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> ''</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">style</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">transitionDelay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999"> ''</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">for</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> of</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> moveElements</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">addEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transitionend</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">classList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">remove</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">transition-move</span><span style="--s-dark:#C98A7D99;--s-light:#B5695999">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p><a href="https://github.com/shikijs/shiki-magic-move/blob/5ec48554d87b4f4e2dd2e15f27ef9e51ef00074b/src/renderer.ts#L254-L276" target="_blank" rel="noopener">[actual source code]</a></p><h2 id="integrations" tabindex="-1">Integrations <a class="header-anchor" href="#integrations" aria-hidden="true">#</a></h2><p>Shiki Magic Move is open-sourced at <span ws-nowrap=""><svg style="vertical-align:sub" class="inline inline-block" viewBox="0 0 32 32" width="1.2em" height="1.2em"><path fill="currentColor" fill-rule="evenodd" d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2"></path></svg><a class="opacity-70 ml-1 font-mono" href="https://github.com/shikijs/shiki-magic-move" target="_blank">shikijs/shiki-magic-move</a></span>. The core logic is pretty lightweight and framework-agnostic, despite that the library is a bit low-level. Currently, I only have the bandwidth to make a Vue wrapper for it, and I am counting on you to contribute and add more first-class integrations for other frameworks as well as higher-level integrations.</p><p>If you are using <a href="https://sli.dev/" target="_blank" rel="noopener">Slidev</a>, you can <a href="https://sli.dev/guide/syntax#shiki-magic-move" target="_blank" rel="noopener">try it today</a> to enhance your slides with Magic!</p><p>Hope you enjoy it, happy hacking!</p></div><!--]--></article><div class="prose m-auto mt-8 mb-8 slide-enter animate-delay-500 print:hidden"><!--[--><span font-mono="" op50="">&gt; </span><span op50="">comment on </span><a href="https://elk.zone/intent/post?text=Reading%20%40antfu%40m.webtoo.ls's%20https%3A%2F%2Fantfu.me%2Fposts%2Fshiki-magic-move%0A%0AI%20think..." target="_blank" op50="">mastodon</a><span op25=""> / </span><a href="https://twitter.com/intent/tweet?text=Reading%20%40antfu7's%20https%3A%2F%2Fantfu.me%2Fposts%2Fshiki-magic-move%0A%0AI%20think..." target="_blank" op50="">twitter</a><!--]--><br><span font-mono="" op50="">&gt; </span><a href="/posts" class="font-mono op50 hover:op75"></a></div><!--]--><div class="mt-10 mb-6 prose m-auto flex slide-enter animate-delay-1200!"><span class="text-sm op50"><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color:inherit">CC BY-NC-SA 4.0</a> 2021-PRESENT ¬© Au Taoo</span><div class="flex-auto"></div></div></main><!----><!--]--></div><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></body></html>